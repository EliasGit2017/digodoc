<button id="update-filters" style="display: none;"><img src="static/imgs/filter.ico" />Update filters</button>

<!-- Search by entry 1-->
<div id="forms" style="display: none;">
 
  <button type="button" class="collapsible-div">Search by entry</button>

  <div class="form-div" style="display: block;">
    <form class="search-form" id="entry-form">
      <table>
        <tbody>
          <tr>
            <td colspan="2">
              <label for="fpattern_entry">Search pattern:</label><br>
              <input type="text" class="fpattern" id="fpattern_entry" name="fpattern_entry" value=""><br>
            </td>
          </tr>
          <tr>
            <td>
              <input type="checkbox" id="fpackages" name="fpackages" value="Packages">
              <label for="fpackages">Packages</label>
            </td>
            <td>
              <input type="checkbox" id="flibraries" name="flibraries" value="Libraries">
              <label for="flibraries">Libraries</label>
            </td>
          </tr>
          <tr>
            <td>
              <input type="checkbox" id="fmodules" name="fmodules" value="Modules">
              <label for="fmodules">Modules</label><br>
            </td>
            <td>
              <input type="checkbox" id="fmetas" name="fmetas" value="Metas">
              <label for="fmetas">Metas</label>
            </td>
          </tr>
          <tr>
            <td>
              <input type="checkbox" id="fsources" name="fsources" value="Sources">
              <label for="fsources">Sources</label><br>
            </td>
          </tr>
          <tr>
            <td style="text-align: center;" colspan="2">
              <input type="submit" class="submitstyle" value="Search">
            </td>
          </tr>
        </tbody>
      </table>
    </form>
  </div>

  <!-- Search by functions, types, classes, etc. -->

  <button type="button" class="collapsible-div">Search by element</button>

  <div class="form-div" style="display: block;">
    <form class="search-form" id="element-form">
      <table>
        <tbody>
          <tr>
            <td colspan="2">
              <label for="fpattern_element">Search pattern:</label>
              <input type="text" class="fpattern" id="fpattern_element" name="fpattern_element" value=""><br>
            </td>
          </tr>
          <tr>
            <td>
              <label class="switch">
                <input type="checkbox" id="fregex" checked onclick="myhider()">
                <span class="slider round"></span>
              </label>
              <label>Pattern or <a style="color: green;">RegEx</a></label>
            </td>
          </tr>
          <tr>
            <td>
              <input type="checkbox" id="fvals" name="fvals" value="Values">
              <label for="fvals">Values</label>
            </td>
            <td>
              <input type="checkbox" id="fclasses" name="fclasses" value="Classes">
              <label for="fclass">Classes</label>
            </td>
          </tr>
          <tr>
            <td>
              <input type="checkbox" id="ftypes" name="ftypes" value="Types">
              <label for="ftypes">Types</label><br>
            </td>
          </tr>
          <tr id="tohide">
            <td colspan="2">
              <input type="checkbox" id="showpacksearch" value="Package" onclick="togglepack()">
              <label for="showpacksearch">in Packages</label>
              <div id="nsbp" class="newSearchbyPack" onclick="focusMethod1()">
                <input type="text" id="ftextpackages" name="packinput" value="" placeholder="" size="1"><br>
              </div>
            </td>
          </tr>
          <tr id="tohide2">
            <td colspan="2">
              <input type="checkbox" id="showmodsearch" value="Module" onclick="togglemod()">
              <label for="showmodsearch">in Modules&nbsp;</label>
              <div id="nsbm" class="newSearchbyModule" onclick="focusMethod2()">
                <input type="text" id="ftextmodules" name="modinput" value="" placeholder="" size="1"><br>
              </div>
            </td>
          </tr>
          <tr>
            <td style="text-align: center;" colspan="2">
              <input type="submit" class="submitstyle" value="Search">
            </td>
          </tr>
        </tbody>
      </table>
    </form>
  </div>
</div>

<div id="entries-nav" style="display: none;">
  <table>
    <tbody>
      <tr>
        <td><a id="packages-results" style="display: none;">Packages</a></td>
        <td><a id="libraries-results" style="display: none;">Libraries</a></td>
        <td><a id="modules-results" style="display: none;">Modules</a></td>
        <td><a id="metas-results" style="display: none;">Metas</a></td>
        <td><a id="sources-results" style="display: none;">Sources</a></td>
        <td><a id="vals-results" style="display: none;">Values</a></td>
        <td><a id="types-results" style="display: none;">Types</a></td>
        <td><a id="classes-results" style="display: none;">Classes</a></td>
      </tr>
    </tbody>
  </table>
</div>

<div id="result-div" style="display: none;">
  <div id="page-info">

  </div>
  <div id="results">
    <ol id="results-list">

    </ol>
  </div>
  <nav id="pagination-nav">
    <a id="previous-page" style="display: none;" href="">
      <svg width="29" height="29" viewBox="0 0 29 29" xmlns="http://www.w3.org/2000/svg"><circle fill="#D6D6D5" cx="14.5" cy="14.5" r="14.5"></circle><path fill="#FFF" d="M14.5 19v-3h5v-3h-5v-3L9 14.5z"></path></svg>
    </a>
    <ol id="pages">
    </ol>
    <a id="next-page" style="display: none;" href="">
      <svg width="29" height="29" viewBox="0 0 29 29" xmlns="http://www.w3.org/2000/svg"><circle fill="#D6D6D5" cx="14.5" cy="14.5" r="14.5"></circle><path fill="#FFF" d="M15 19v-3h-5v-3h5v-3l5.5 4.5z"></path></svg>
    </a>
  </nav>
</div>

<script>
  /******************* Only one collapsible at a time *******************************/
  var coll = document.getElementsByClassName("collapsible-div");

  for (var i = 0; i < coll.length; i++) {
    coll[i].addEventListener("click", function () {
      for (j = 0; j < coll.length; j++) {
        if (coll[j] != coll[i]) {
          var nocontent = coll[j].nextElementSibling;
          nocontent.style.display = "none";
        }
      }
      this.classList.toggle("active");
      var content = this.nextElementSibling;
      if (content.style.display === "block") {
        content.style.display = "none";
      } else {
        content.style.display = "block";
      }
    });
  }
</script>

<script>

  var chosen_packs = [];

  function generate_package_Tag(tag_name, preceding_elt, parent) {

    /* Generate two spans : one for the tag having the package name + version
    * as innerText and the other to remove the tag when clicked
    */
    let tag_to_insert = document.createElement("span");
    tag_to_insert.classList.add('tag');
    tag_to_insert.innerText = tag_name;
    let tag_remove_btn = document.createElement("span");
    tag_remove_btn.classList.add('remove');
    tag_remove_btn.addEventListener("click", function () {
      //chosen_packs.delete(this.parentElement.innerText);
      //chosen_packs.splice(chosen_packs.indexOf(tag_name), 1);
      this.parentElement.remove();
      chosen_packs = chosen_packs.filter(e => e !== tag_name);
    });
    tag_to_insert.appendChild(tag_remove_btn);
    parent.insertBefore(tag_to_insert, preceding_elt);
  }

  function previewpacks() {
    var input, filter, ul, li, a, txtValue;
    var packages_list = [];
    var parent = document.getElementById('nsbp');

    mylist = document.getElementById('packsUl');
    mylist.querySelectorAll('*').forEach(n => n.remove());

    input = document.getElementById("ftextpackages");
    filter = input.value.toUpperCase();

    if (filter != '') {
      mylist.style.display = "block";
    } else {
      mylist.style.display = "none";
    }

    fetch('https://docs-api.ocaml.pro/packages/0+.+' + filter).then(response => {
      if (response.ok) {
        return response.json();
      } else {
        throw new Error(response.statusText);
      }
    })
      .then(data => {
        packages_list = data.map(({ name, version }) => name + ' ' + version);
        for (var i = 0; i < 10 && i < packages_list.length; i++) {
          let name = packages_list[i];
          let li = document.createElement('li');
          li.addEventListener("click", function () {
            if (chosen_packs.includes(name)) {
              alert('Error : package ' + name + ' already chosen,\nCheck for a different version');
            } else {
              generate_package_Tag(name, input, parent);
              chosen_packs.push(name);
              input.value = '';
              mylist.style.display = "none";
            }
          });
          li.style.display = "block";
          let a = document.createElement('a');
          a.setAttribute("href", "#");
          let node = document.createTextNode(packages_list[i]);
          a.appendChild(node);
          li.appendChild(a);
          mylist.appendChild(li);
        }
      })

    ul = document.getElementById("packsUl");
    li = ul.getElementsByTagName("li");
    for (var i = 0; filter != '' && i < li.length; i++) {
      a = li[i].getElementsByTagName("a")[0];
      a.style.display = "block";
      txtValue = a.textContent || a.innerText;
      if (txtValue.toUpperCase().indexOf(filter) > -1) {
        li[i].style.display = "";
      } else {
        li[i].style.display = "none";
      }
    }
  }

  function backspace_rm_pack(event) {
    var input = document.getElementById("ftextpackages");
    var e = event.keyCode;
    if (e == 8 && input.value == '' ) {
      var previoustag = input.previousSibling;
      chosen_packs = chosen_packs.filter(e => e !== previoustag.innerText);
      previoustag.remove();
    }
  }

</script>

<script>
  var chosen_mods = [];

  function generate_module_Tag(tag_name, preceding_elt, parent) {
    /* Generate two spans : one for the tag having the module name + opam refs
    * as innerText and the other to remove the tag when clicked
    */
    let tag_to_insert = document.createElement("span");
    tag_to_insert.classList.add('tag');
    tag_to_insert.innerText = tag_name;
    let tag_remove_btn = document.createElement("span");
    tag_remove_btn.classList.add('remove');
    tag_remove_btn.addEventListener("click", function () {
      this.parentElement.remove();
      chosen_mods = chosen_mods.filter(e => e !== tag_name);
    });
    tag_to_insert.appendChild(tag_remove_btn);
    parent.insertBefore(tag_to_insert, preceding_elt);
  }

  function previewmods() {
    var input, filter, ul, li, a, txtValue;
    var mods_list = [];
    var parent = document.getElementById('nsbm');

    mylist = document.getElementById('modsUl');
    mylist.querySelectorAll('*').forEach(n => n.remove());

    input = document.getElementById("ftextmodules");
    filter = input.value.toUpperCase();

    if (filter != '') {
      mylist.style.display = "block";
    } else {
      mylist.style.display = "none";
    }

    fetch('https://docs-api.ocaml.pro/modules/0+.+' + filter).then(response => {
      if (response.ok) {
        return response.json();
      } else {
        throw new Error(response.statusText);
      }
    })
      .then(data => {
        mods_list = data.map(({ name, opam }) => name + ' || ' + opam);
        for (var i = 0; i < 10 && i < mods_list.length; i++) {
          let name = mods_list[i];
          let li = document.createElement('li');
          li.addEventListener("click", function () {
            if (chosen_mods.includes(name)) {
              alert('Error : module \n' + name + '\n already chosen,\nCheck for a different version');
            } else {
              generate_module_Tag(name, input, parent);
              chosen_mods.push(name);
              input.value = '';
              mylist.style.display = "none";
            }
          });
          li.style.display = "block";
          let a = document.createElement('a');
          a.setAttribute("href", "#");
          let node = document.createTextNode(mods_list[i]);
          a.appendChild(node);
          li.appendChild(a);
          mylist.appendChild(li);
        }
      })

    ul = document.getElementById("modsUl");
    li = ul.getElementsByTagName("li");
    for (var i = 0; filter != '' && i < li.length; i++) {
      a = li[i].getElementsByTagName("a")[0];
      a.style.display = "block";
      txtValue = a.textContent || a.innerText;
      if (txtValue.toUpperCase().indexOf(filter) > -1) {
        li[i].style.display = "";
      } else {
        li[i].style.display = "none";
      }
    }
  }

  function backspace_rm_mod(event) {
    var input = document.getElementById("ftextmodules");
    var e = event.keyCode;
    if (e == 8 && input.value == '') {
      var previoustag = input.previousSibling;
      chosen_mods = chosen_mods.filter(e => e !== previoustag.innerText);
      previoustag.remove();
    }
  }
</script>

<script>
  /**************** Show/Hide text input for package and modules search ***********/
  function togglepack() {
    var checker = document.getElementById("showpacksearch");
    if (checker.checked) {
      document.getElementById("nsbp").style.display = "block";
    } else {
      document.getElementById("nsbp").style.display = "none"
    }
  }

  function togglemod() {
    var checker = document.getElementById("showmodsearch");
    if (checker.checked) {
      document.getElementById("nsbm").style.display = "block";
    } else {
      document.getElementById("nsbm").style.display = "none"
    }
  }
</script>

<script>
  /* Focus on input when clicking the newSearchbyPack div */
  focusMethod1 = function focusinput() {
    document.getElementById("ftextpackages").focus();
  }
</script>

<script>
  /****************** Hide/Show packages and module option slider (green switch) ************************/
  function myhider() {
    /* Hide ftextpackages and ftextmodules if slidebox is unchecked*/
    var zechecker = document.getElementById("fregex");
    if (!zechecker.checked) {
      document.getElementById("tohide").style.display = "none";
      document.getElementById("tohide2").style.display = "none";
    } else {
      document.getElementById("tohide").style.display = "";
      document.getElementById("tohide2").style.display = "";
    }
  }
</script>

<script>
  /* Focus on input when clicking the newSearchbyModule div */
  focusMethod2 = function focusinput2() {
    document.getElementById("ftextmodules").focus();
  }
</script>


